!function(t){function e(){function t(t){function e(t){for(var e,r=[],a=-1,l=t.length;++a<l;)e=t[a],r.push("M",n(e.key),",",f,"V",o(e.value),"h9V",f);return r.join("")}function a(t){var e=+("e"==t),n=e?1:-1,r=f/3;return"M"+.5*n+","+r+"A6,6 0 0 "+e+" "+6.5*n+","+(r+6)+"V"+(2*r-6)+"A6,6 0 0 "+e+" "+.5*n+","+2*r+"ZM"+2.5*n+","+(r+8)+"V"+(2*r-8)+"M"+4.5*n+","+(r+8)+"V"+(2*r-8)}var i=n.range()[1],f=o.range()[0];o.domain([0,l.top(1)[0].value]),t.each(function(){var t=d3.select(this),o=t.select("g");if(o.empty()){o=t.append("svg").attr("width",i+c.left+c.right).attr("height",f+c.top+c.bottom).append("g").attr("transform","translate("+c.left+","+c.top+")"),o.append("clipPath").attr("id","clip-"+s).append("rect").attr("width",i).attr("height",f),o.selectAll(".bar").data(["background","foreground"]).enter().append("path").attr("class",function(t){return t+" bar"}).datum(l.all()),o.selectAll(".foreground.bar").attr("clip-path","url(#clip-"+s+")"),o.append("g").attr("class","axis").attr("transform","translate(0,"+f+")").call(u);var h=o.append("g").attr("class","brush").call(d);h.selectAll("rect").attr("height",f),h.selectAll(".resize").append("path").attr("d",a)}if(r)if(r=!1,o.selectAll(".brush").call(d),d.empty())o.selectAll("#clip-"+s+" rect").attr("x",0).attr("width",i);else{var p=d.extent();o.selectAll("#clip-"+s+" rect").attr("x",n(p[0])).attr("width",n(p[1])-n(p[0]))}o.selectAll(".bar").attr("d",e)})}e.id||(e.id=0);var n,r,a,l,i,c={top:10,right:10,bottom:20,left:10},o=d3.scale.linear().range([100,0]),s=e.id++,u=d3.svg.axis().orient("bottom"),d=d3.svg.brush();return d.on("brush.chart",function(){var t=d3.select(this.parentNode),e=d.extent();i&&t.select(".brush").call(d.extent(e=e.map(i))).selectAll(".resize").style("display",null),t.select("#clip-"+s+" rect").attr("x",n(e[0])).attr("width",n(e[1])-n(e[0])),a.filterRange(e)}),d.on("brushend.chart",function(){if(d.empty()){var t=d3.select(this.parentNode.parentNode.parentNode);t.select("#clip-"+s+" rect").attr("x",null).attr("width","100%"),a.filterAll()}}),t.margin=function(e){return arguments.length?(c=e,t):c},t.x=function(e){return arguments.length?(n=e,u.scale(n),d.x(n),t):n},t.y=function(e){return arguments.length?(o=e,t):o},t.dimension=function(e){return arguments.length?(a=e,t):a},t.filter=function(e){return e?(d.extent(e),a.filterRange(e)):(d.clear(),a.filterAll()),r=!0,t},t.group=function(e){return arguments.length?(l=e,t):l},t.round=function(e){return arguments.length?(i=e,t):i},d3.rebind(t,d,"on")}function n(t){function e(){function e(n,r){r.children.forEach(function(r){var a=t[r];a.depth=n,e(n+1,a),o=Math.max(o,n+1)})}var n=[];l(t,function(t,e){0==e.b&&d.push(e),e.children=[],e.id=t,n.push(e)}),l(t,function(e,n){0!=n.b&&t[n.b].children.push(e)});var r=u.selectAll("g").data(n,function(t){return t.id}),c=r.enter().append("g").attr("class","stack");c.append("rect").attr("height",20).attr("width",200).attr("rx",2).attr("ry",2),c.append("text").attr("x",10).attr("y",15).text(function(t){return t.f});var o=0;d.forEach(function(t){t.depth=0,e(1,t)});var s=(o+1)*i;u.style("height",""+s+"px"),u.selectAll("g.stack").each(function(t){var e=s-(t.depth+1)*i,n=d3.select(this);n.selectAll("rect").attr("y",e),n.selectAll("text").attr("y",e+a)})}function n(e,n){function r(a){var l=e.samples[a],c=n.samples[a];return t[a].children.forEach(function(t){var e=r(t);l+=e[0],c+=e[1]}),i[a]=l,f[a]=c,[l,c]}function a(e,n){v[n]=e,t[n].children.forEach(function(t){a(e,t),e-=m[t]})}if(0==n.total)return void u.style("display","none");u.style("display",null);var i={},f={};d.forEach(function(t){r(t.id)});var h=0;d.forEach(function(t){h+=f[t.id]});var p=c/h,m={};l(t,function(t){m[t]=Math.floor(f[t]*p)});var v={},g=c;d.forEach(function(e){a(g,e.id),g-=m[t]});var x=u.selectAll("g.stack");x.selectAll("text").attr("x",function(t){return v[t.id]-m[t.id]+o}).attr("width",function(t){return m[t.id]-o}).text(function(t){var e=m[t.id],n=e/s;return t.f.length<=n?t.f:1>=n?"":2==n?t.f.substr(0,1)+".":t.f.substr(0,n)+".."}),x.selectAll("rect").attr("x",function(t){return v[t.id]-m[t.id]}).attr("width",function(t){return m[t.id]})}var r={UpdateCounts:n},a=15,i=20,c=1516,o=5,s=10,u=d3.selectAll("#flamegraph"),d=[];return e(),r}function a(t){function a(t){var e=y[t];if(E[0].hasOwnProperty(t))return t;for(var n=0;A>n;++n){var r=w[n].dimension(function(e){return e[t]}),a=r.group(function(t){var n=e.bucketSize;return Math.floor(t/n)*n});E[n][t]=r,M[n][t]=a}return k[t]={name:e.name,min:e.min,max:e.max},d3.selectAll("#metric-selector-"+t).style("display","none"),i(t),t}function i(t){if(!V.hasOwnProperty(t)){for(var n=k[t],r=[],a=0;A>a;++a)r.push(e().dimension(E[a][t]).group(M[a][t]).x(d3.scale.linear().domain([n.min,n.max]).rangeRound([0,10*b])));V[t]={id:t,name:n.name,charts:r},u(V)}}function c(t){delete V[t],delete k[t];for(var e=0;A>e;++e)M[e][t].dispose(),delete M[e][t],E[e][t].dispose(),delete E[e][t];d3.selectAll("#metric-selector-"+t).style("display",null),u(V)}function o(t){d3.select(this).call(t)}function s(){d3.selectAll("div.chart").each(o),p.UpdateCounts(P[0].value(),P[1].value()),d3.selectAll("#active-left").text(g(P[0].value().total)),d3.selectAll("#active-right").text(g(P[1].value().total))}function u(t){var e=[];l(t,function(t,n){e.push(n)});var n=d3.selectAll("#charts").selectAll("div.chart-container").data(e,function(t){return t.id}),r=n.enter().append("div").attr("class","chart-container"),a=r.append("div").attr("class","chart-title");a.append("span").text(function(t){return t.name}),a.append("a").text("Remove").attr("href","#").on("click",function(t){return c(t.id),!1});var i=r.selectAll("div.chart").data(function(t){return t.charts});i.enter().append("div").attr("class","chart").each(function(t){t.on("brush",s).on("brushend",s)}),n.exit().remove(),n.order(),s()}function d(t,e){return t.total+=1,l(e.samples,function(e,n){t.samples[e]+=n}),t}function f(t,e){return t.total-=1,l(e.samples,function(e,n){t.samples[e]-=n}),t}function h(){return r={total:0,samples:{}},l(m,function(t){r.samples[t]=0}),r}var p,m,v={},g=d3.format(",d"),x={a:"duration",b:"usermode",c:"system calls",d:"interrupted",e:"wait-cpu",f:"wait-blocked",g:"timer",h:"network",i:"block-device",j:"user-input"},A=2,b=50,y={},w=[],k={},E=[],M=[],P=[],V={};return d3.json(t,function(t,e){m=e.stacks,e.executions.forEach(function(t){t.a=t.a/1e3,t.b=t.a*(.5+Math.random())});var r=[];e.executions.forEach(function(t){l(t,function(e){if("samples"!=e)if(y.hasOwnProperty(e)){var n=y[e];n.min=Math.min(n.min,t[e]),n.max=Math.max(n.max,t[e])}else{var n={id:e,name:x[e],min:t[e],max:t[e]};y[e]=n,r.push(n)}})}),r.forEach(function(t){t.bucketSize=(t.max-t.min)/b});for(var i=0;A>i;++i)w.push(crossfilter(e.executions)),E.push({}),M.push({}),P.push(w[i].groupAll()),P[i].reduce(d,f,h);var c=d3.selectAll("#metric-selector").selectAll("li").data(r,function(t){return t.id}),o=c.enter().append("li");o.text(function(t){return t.name}),o.attr("id",function(t){return"metric-selector-"+t.id}),o.on("click",function(t){a(t.id)}),c.exit().remove(),d3.selectAll("#total-left").text(g(e.executions.length)),d3.selectAll("#total-right").text(g(e.executions.length)),p=n(e.stacks),s()}),v}function l(t,e){for(var n in t)t.hasOwnProperty(n)&&e(n,t[n])}a.version="1.0.0",t.tracecompare=a}("undefined"!=typeof exports&&exports||this);