!function(t){function n(t){function e(t){function n(t){for(var n,e=[],a=-1,i=t.length;++a<i;)n=t[a],e.push("M",r(n.key),",",o,"V",u(n.value),"h9V",o);return e.join("")}function e(t){var n=+("e"==t),e=n?1:-1,r=o/3;return"M"+.5*e+","+r+"A6,6 0 0 "+n+" "+6.5*e+","+(r+6)+"V"+(2*r-6)+"A6,6 0 0 "+n+" "+.5*e+","+2*r+"ZM"+2.5*e+","+(r+8)+"V"+(2*r-8)+"M"+4.5*e+","+(r+8)+"V"+(2*r-8)}var i=r.range()[1],o=u.range()[0];u.domain([0,l.top(1)[0].value]),t.each(function(){var t=d3.select(this),u=t.select("g");if(u.empty()){u=t.append("svg").attr("width",i+c.left+c.right).attr("height",o+c.top+c.bottom).append("g").attr("transform","translate("+c.left+","+c.top+")"),u.append("clipPath").attr("id","clip-"+s).append("rect").attr("width",i).attr("height",o),u.selectAll(".bar").data(["background","foreground"]).enter().append("path").attr("class",function(t){return t+" bar"}).datum(l.all()),u.selectAll(".foreground.bar").attr("clip-path","url(#clip-"+s+")"),u.append("g").attr("class","axis").attr("transform","translate(0,"+o+")").call(d);var p=u.append("g").attr("class","brush").call(f);p.selectAll("rect").attr("height",o),p.selectAll(".resize").append("path").attr("d",e)}if(a)if(a=!1,u.selectAll(".brush").call(f),f.empty())u.selectAll("#clip-"+s+" rect").attr("x",0).attr("width",i);else{var h=f.extent();u.selectAll("#clip-"+s+" rect").attr("x",r(h[0])).attr("width",r(h[1])-r(h[0]))}u.selectAll(".bar").attr("d",n)})}n.id||(n.id=0);var r,a,i,l,o,c={top:10,right:10,bottom:20,left:10},u=d3.scale.linear().range([100,0]),s=n.id++,d=d3.svg.axis().orient("bottom"),f=d3.svg.brush();return f.on("brush.chart",function(){var t=d3.select(this.parentNode),n=f.extent();o&&t.select(".brush").call(f.extent(n=n.map(o))).selectAll(".resize").style("display",null),t.select("#clip-"+s+" rect").attr("x",r(n[0])).attr("width",r(n[1])-r(n[0])),i.filterRange(n)}),f.on("brushend.chart",function(){if(f.empty()){var n=d3.select(this.parentNode.parentNode.parentNode);n.select("#clip-"+s+" rect").attr("x",null).attr("width","100%"),i.filterAll()}t()}),e.margin=function(t){return arguments.length?(c=t,e):c},e.x=function(t){return arguments.length?(r=t,d.scale(r),f.x(r),e):r},e.y=function(t){return arguments.length?(u=t,e):u},e.dimension=function(t){return arguments.length?(i=t,e):i},e.filter=function(t){return t?(f.extent(t),i.filterRange(t)):(f.clear(),i.filterAll()),a=!0,e},e.group=function(t){return arguments.length?(l=t,e):l},e.round=function(t){return arguments.length?(o=t,e):o},d3.rebind(e,f,"on")}function e(t,n,e){function r(){function n(e,r){r.children.forEach(function(r){var a=t[r];a.depth=e,n(e+1,a),o=Math.max(o,e+1)})}var r=[];i(t,function(t,n){0==n.b&&k.push(n),n.children=[],n.id=parseInt(t),r.push(n)}),i(t,function(n,e){0!=e.b&&t[e.b].children.push(n)});var a=M.selectAll("g").data(r,function(t){return t.id}),l=a.enter().append("g").attr("class","stack");l.append("rect").attr("height",20).attr("width",200).attr("rx",2).attr("ry",2).on("click",function(t){e(t.id,"linear")}),l.append("text").attr("x",10).attr("y",15).text(function(t){return t.f}).on("click",function(t){e(t.id,"linear")});var o=0;k.forEach(function(t){t.depth=0,n(1,t)});var c=(o+1)*p;M.style("height",""+c+"px"),M.selectAll("g.stack").each(function(t){var n=c-(t.depth+1)*p,e=d3.select(this);e.selectAll("rect").attr("y",n),e.selectAll("text").attr("y",n+f)})}function a(t,n){0==g&&(n=!0);var e=0;k.forEach(function(n){e+=t.samples[n.id]}),e/=t.total;var r=window.innerWidth-h;(n||e*g>=r)&&(g=r/e)}function c(t,n){var e=M.selectAll("g.stack").transition();e.selectAll("text").attr("x",function(n){return t[n.id]+v}).attr("width",function(t){return n[t.id]<v?0:n[t.id]-v}).text(function(t){var e=n[t.id],r=e/m;return l(t.f,r)}),e.selectAll("rect").attr("x",function(n){return t[n.id]}).attr("width",function(t){return n[t.id]}).attr("class",function(t){return 0==n[t.id]?"invisible":""}).style("fill",function(t){var n=x[t.id];return void 0===n&&(n=y),"rgb("+n[0]+","+n[1]+","+n[2]+")"})}function u(n,e,r){function l(n,e){s[e]=n,t[e].children.forEach(function(t){l(n,t),n+=o[t]})}if(0==e.total)return void M.style("display","none");M.style("display",null),a(e,r);var o={},u=g/e.total;i(t,function(t){o[t]=Math.floor(e.samples[t]*u)});var s={},d=0;k.forEach(function(t){l(d,t.id),d+=o[t.id]}),c(s,o)}function s(n,e,r){var a={};i(n.samples,function(t,e){a[t]=e/n.total});var l={},c={};r.forEach(function(t){i(t.samples,function(t,n){var e=n-a[t],r=l[t];void 0===r&&(r=0),l[t]=r+e*e,c.hasOwnProperty(t)?++c[t]:c[t]=1})}),0!=r.length?i(l,function(t,n){var e=c[t]*a[t];n+=e*e*(r.length-c[t]),l[t]=Math.sqrt(n/r.length)}):i(l,function(t){l[t]=0}),i(t,function(t){var n=a[t];void 0===n&&(n=0);var r=e.samples[t];void 0===r&&(r=0),0!=e.total&&(r/=e.total);var i=r-n,c=1/0,u=l[t];void 0!==u&&(c=i/u);var s=A*(o(Math.abs(c),b,w)-b)/(w-b);x[t]=i>0?[A,A-s,A-s]:[A-s,A,A-s]})}var d={UpdateCounts:u,UpdateColors:s},f=15,p=20,h=40,v=5,m=10,g=0,x={},A=238,y=[A,A,A],b=1,w=3,k=[],M=d3.selectAll("#flamegraph");return r(),d}function a(t){function a(t,n,e){var r,a;if("linear"==t){var i=(e-n)/C,l=n-i,o=e+i;r=(o-l)/C,a=d3.scale.linear().domain([l,o]).rangeRound([0,P*C])}else if("log"==t){var l=Math.max(E,n),o=e;r=(o-l)/C,a=d3.scale.log().clamp(!0).domain([l,o]).rangeRound([0,P*C])}return[r,a]}function o(t,n,e){return"linear"==n?function(n){return Math.floor(n/t)*t}:function(t){return t=Math.max(E,t),e.invert(Math.floor(e(t)/P)*P)}}function c(t,n){var e=U[t];if(z[0].hasOwnProperty(t))return t;for(var r=a(n,e.min,e.max),i=r[0],l=r[1],c=0;M>c;++c){var u=R[c].dimension(function(e){var r=e[t];return void 0===r&&(r=0),"linear"==n?r:Math.max(E,r)}),s=u.group(o(i,n,l));z[c][t]=u,N[c][t]=s}return V[t]=e.name,d3.selectAll("#metric-selector-"+t).style("display","none"),d(t,n,l),t}function u(t,n){var e=parseInt(t);if(z[0].hasOwnProperty(e))return e;var r=y[t].min,i=y[t].max;if(0==i||void 0===i)return console.log("Cannot filter on this stack duration."),alert("Cannot filter on this stack duration."),-1;for(var c=a(n,r,i),u=c[0],s=c[1],f=0;M>f;++f){var p=R[f].dimension(function(e){var r=e.samples[t];return void 0===r&&(r=0),"linear"==n?r:Math.max(E,r)}),h=p.group(o(u,n,s));z[f][e]=p,N[f][e]=h}return V[e]=l(y[t].f,O),d(e,n,s),e}function s(){A.UpdateColors(j[0].value(),j[1].value(),I[0].top(1/0))}function d(t,e,r){if(!L.hasOwnProperty(t)){for(var a=V[t],i=[],l=0;M>l;++l)i.push(n(s).dimension(z[l][t]).group(N[l][t]).x(r));L[t]={id:t,name:a,charts:i},v(L,e)}}function f(t){delete L[t],delete V[t];for(var n=0;M>n;++n)N[n][t].dispose(),delete N[n][t],z[n][t].dispose(),delete z[n][t];d3.selectAll("#metric-selector-"+t).style("display",null),v(L)}function p(t){d3.select(this).call(t)}function h(){d3.selectAll("div.chart").each(p),A.UpdateCounts(j[0].value(),j[1].value(),!1),d3.selectAll("#active-left").text(w(j[0].value().total)),d3.selectAll("#active-right").text(w(j[1].value().total))}function v(t,n){var e=[];i(t,function(t,n){e.push(n)});var r=d3.selectAll("#charts").selectAll("div.chart-container").data(e,function(t){return t.id}),a=r.enter().append("div").attr("class","chart-container"),l=a.append("div").attr("class","chart-title");l.append("span").text(function(t){return t.name}),l.append("a").text("Remove").attr("href","#").on("click",function(t){f(t.id)}),l.append("a").text(function(){return"log"==n?"Linear":"Log"}).attr("href","#").on("click",function(t){f(t.id),"linear"==n?"string"==typeof t.id?c(t.id,"log"):u(t.id,"log"):"string"==typeof t.id?c(t.id,"linear"):u(t.id,"linear")});var o=a.selectAll("div.chart").data(function(t){return t.charts});o.enter().append("div").attr("class","chart").each(function(t){t.on("brush",h).on("brushend",h)}),r.exit().remove(),r.order(),h()}function m(t,n){return t.total+=1,i(n.samples,function(n,e){t.samples[n]+=e}),t}function g(t,n){return t.total-=1,i(n.samples,function(n,e){t.samples[n]-=e}),t}function x(){return r={total:0,samples:{}},i(y,function(t){r.samples[t]=0}),r}var A,y,b={},w=d3.format(",d"),k={a:"duration",b:"timestamp",c:"unknown",d:"vertical",e:"run",f:"interrupted",g:"wait-cpu",h:"wait-blocked",i:"timer",j:"network",k:"block-device",l:"user-input"},M=2,C=50,P=10,E=1,O=20,U={},R=[],V={},z=[],N=[],j=[],I=[],L={};return d3.json(t,function(t,n){y=n.stacks;var r=[];n.executions.forEach(function(t){i(t,function(t,n){if("samples"!=t)if(U.hasOwnProperty(t)){var e=U[t];e.min=Math.min(e.min,n),e.max=Math.max(e.max,n)}else{var e={id:t,name:k[t],min:n,max:n};U[t]=e,r.push(e)}}),i(t.samples,function(t,n){var e=y[t];e.hasOwnProperty("min")?(e.min=Math.min(e.min,n),e.max=Math.max(e.max,n),++e.count):(e.min=n,e.max=n,e.count=1)})}),i(y,function(t,e){e.count!=n.executions.length&&(e.min=0),delete e.count});for(var a=0;M>a;++a)R.push(crossfilter(n.executions)),z.push({}),N.push({}),j.push(R[a].groupAll()),j[a].reduce(m,g,x);for(var a=0;M>a;++a)I.push(R[a].dimension(function(){return 0}));var l=d3.selectAll("#metric-selector").selectAll("li").data(r,function(t){return t.id}),o=l.enter().append("li");o.text(function(t){return t.name}),o.attr("id",function(t){return"metric-selector-"+t.id}),o.on("click",function(t){c(t.id,"linear")}),l.exit().remove(),d3.selectAll("#zoom").on("click",function(){A.UpdateCounts(j[0].value(),j[1].value(),!0)}),window.onresize=function(){A.UpdateCounts(j[0].value(),j[1].value(),!0)},d3.selectAll("#total-left").text(w(n.executions.length)),d3.selectAll("#total-right").text(w(n.executions.length)),A=e(n.stacks,I[0],u),h()}),b}function i(t,n){for(var e in t)t.hasOwnProperty(e)&&n(e,t[e])}function l(t,n){return t.length<=n?t:1>=n?"":2==n?t.substr(0,1)+".":t.substr(0,n)+".."}function o(t,n,e){return Math.min(Math.max(t,n),e)}a.version="1.0.0",t.tracecompare=a}("undefined"!=typeof exports&&exports||this);